name: Build V8 Android ARM64 (d8)

on:
  push:
    branches: [ main ]
    paths:
      - '**'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      # 1ï¸âƒ£ æ£€å‡ºä»“åº“
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ è¯»å– V8 ç‰ˆæœ¬
      - name: Read V8 version
        id: version
        run: |
          V8_VERSION=$(cat v8_tag.txt | tr -d '\n')
          echo "v8_version=${V8_VERSION}" >> $GITHUB_OUTPUT
          echo "Building V8 version: ${V8_VERSION}"

      # 3ï¸âƒ£ ç¼“å­˜ depot_tools + v8
      - name: Cache depot_tools and v8
        uses: actions/cache@v4
        with:
          path: |
            ~/depot_tools
            ${{ github.workspace }}/v8
          key: v8-${{ steps.version.outputs.v8_version }}

      # 4ï¸âƒ£ å®‰è£…åŸºç¡€ä¾èµ–
      - name: Install base dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git python3 pkg-config build-essential \
              ninja-build curl unzip default-jdk

      # 5ï¸âƒ£ å®‰è£… Android SDK & NDK
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android NDK
        run: |
          sdkmanager --install "ndk;25.2.9519653"

      - name: Set NDK environment variable
        run: |
          echo "ANDROID_NDK_ROOT=$ANDROID_SDK_ROOT/ndk/25.2.9519653" >> $GITHUB_ENV

      # 6ï¸âƒ£ è·å– depot_tools
      - name: Fetch depot_tools
        run: |
          if [ ! -d "$HOME/depot_tools" ]; then
            git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git "$HOME/depot_tools"
          fi
          echo "$HOME/depot_tools" >> $GITHUB_PATH

      # 7ï¸âƒ£ è·å– V8 æºç ã€åˆ‡åˆ†æ”¯ã€é…ç½® .gclient
      - name: Fetch V8 source and configure gclient for Android
        env:
          V8_VERSION: ${{ steps.version.outputs.v8_version }}
        run: |
          cd $GITHUB_WORKSPACE
          if [ ! -d "v8" ]; then
            fetch v8
          fi

          # æ·»åŠ  target_os = ['android']
          if ! grep -q "target_os = \['android'\]" .gclient; then
            sed -i "/^target_os = /d" .gclient
            echo "target_os = ['android']" >> .gclient
          fi

          cd v8
          git fetch --tags
          echo "Checking out version: $V8_VERSION"
          git checkout $V8_VERSION

          # å¼ºåˆ¶åŒæ­¥ä¾èµ–
          gclient sync --with_branch_heads --with_tags --force --reset --delete_unversioned_trees -D

      # 8ï¸âƒ£ GN é…ç½®
      - name: Configure GN
        env:
          ANDROID_NDK_ROOT: ${{ steps.android.outputs.ndk-path }}
        run: |
          cd $GITHUB_WORKSPACE/v8
          gn gen out/android_arm64.release --args="
            target_os=\"android\"
            target_cpu=\"arm64\"
            is_debug=false
            v8_enable_object_print=true
            v8_target_cpu=\"arm64\"
            android_ndk_root=\"$ANDROID_NDK_ROOT\"
            v8_static_library=false
            v8_use_external_startup_data=false
            use_custom_libcxx=false
          "

      # 9ï¸âƒ£ æ„å»º d8
      - name: Build d8
        run: |
          cd $GITHUB_WORKSPACE/v8
          ninja -C out/android_arm64.release d8

      # ğŸ”Ÿ æ‰“åŒ…è¾“å‡ºï¼ˆæ’é™¤ gen å’Œ srcï¼‰
      - name: Package output
        run: |
          cd $GITHUB_WORKSPACE/v8/out
          tar --exclude='android_arm64.release/gen' \
              --exclude='android_arm64.release/src' \
              -czf android_arm64.release.tar.gz android_arm64.release
          mv android_arm64.release.tar.gz $GITHUB_WORKSPACE/

      # 1ï¸âƒ£1ï¸âƒ£ ä¸Šä¼  artifact
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: android_arm64.release
          path: android_arm64.release.tar.gz
